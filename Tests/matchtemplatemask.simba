{$assertions on}

var
  img, templ: TImage;

procedure test(formula: ETMFormula; minLoc, maxLoc: TPoint; minValue, maxValue: Single = 0);
var
  mat: TSingleMatrix;
begin
  try
    mat := MatchTemplateMask(img.ToMatrix(), templ.ToMatrix(), formula);
    Assert(mat.ArgMin() = minLoc);
    Assert(mat.ArgMax() = maxLoc);

    if (minValue <> 0) and (maxValue <> 0) then
    begin
      Assert(Abs(mat[minLoc.Y, minLoc.X] - minValue) <= 0.05);
      Assert(Abs(mat[maxLoc.Y, maxLoc.X] - maxValue) <= 0.05);
    end;
  except
    WriteLn(Formula, ' :: ', mat.ArgMin(), ', ', mat.ArgMax(), ', ', Round(mat[mat.ArgMin().Y, mat.ArgMin().X], 1), ', ', Round(mat[mat.ArgMax().Y, mat.ArgMax().X], 1));
    raise;
  end;
end;

procedure testCache(formula: ETMFormula; minLoc, maxLoc: TPoint; minValue, maxValue: Single = 0);
var
  mat: TSingleMatrix;
  cache: TMatchTemplateCache;
begin
  try
    cache := TMatchTemplateCache.Create(img.toMatrix(), templ.ToMatrix(), formula);
    mat := MatchTemplateMask(cache, templ.ToMatrix(), formula);
    Assert(mat.ArgMin() = minLoc);
    Assert(mat.ArgMax() = maxLoc);

    if (minValue <> 0) and (maxValue <> 0) then
    begin
      Assert(Abs(mat[minLoc.Y, minLoc.X] - minValue) <= 0.05);
      Assert(Abs(mat[maxLoc.Y, maxLoc.X] - maxValue) <= 0.05);
    end;
  except
    WriteLn(Formula, ' :: ', mat.ArgMin(), ', ', mat.ArgMax(), ', ', Round(mat[mat.ArgMin().Y, mat.ArgMin().X], 1), ', ', Round(mat[mat.ArgMax().Y, mat.ArgMax().X], 1));
    raise;
  finally
    cache.free();
  end;
end;

begin
  img := TImage.CreateFromString('IMG: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');

  templ := img.Copy(50, 50, 100, 100);
  templ.DrawCircleInverted(templ.Center(), 20, 0);

  try
    test(TM_CCOEFF, [83, 1], [50, 50]);
    test(TM_CCOEFF_NORMED, [24, 19], [50, 50], -0.2, 1);

    test(TM_CCORR, [80, 14], [53, 0]);
    test(TM_CCORR_NORMED, [77, 1], [50, 50], 0.8, 1);

    test(TM_SQDIFF, [50, 50], [54, 0]);
    test(TM_SQDIFF_NORMED, [50, 50], [59, 0], 0, 0.4);

    testCache(TM_CCOEFF, [83, 1], [50, 50]);
    testCache(TM_CCOEFF_NORMED, [24, 19], [50, 50], -0.2, 1);

    testCache(TM_CCORR, [80, 14], [53, 0]);
    testCache(TM_CCORR_NORMED, [77, 1], [50, 50], 0.8, 1);

    testCache(TM_SQDIFF, [50, 50], [54, 0]);
    testCache(TM_SQDIFF_NORMED, [50, 50], [59, 0], 0, 0.4);
  finally
    img.free();
    templ.free();
  end;
end.
